<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Episode 2.1: Sorted Logs - When Binary Search Meets Persistence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/dist/theme/black.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js/plugin/highlight/monokai.css">
  <style>
    .reveal { 
      font-family: 'Segoe UI', 'Arial', sans-serif; 
      font-size: 28px !important;
    }
    .reveal .slides { font-size: 28px !important; }
    .reveal h1 { font-size: 1.8em !important; }
    .reveal h2 { font-size: 1.4em !important; }
    .reveal h3 { font-size: 1.15em !important; }
    .reveal h1, .reveal h2, .reveal h3 { text-transform: none; }
    
    /* Thesis and Framework Styles */
    .thesis-box {
      background: linear-gradient(135deg, rgba(245,158,66,0.9), rgba(245,87,108,0.9));
      border: 2px solid #f59e42;
      border-radius: 10px;
      margin: 12px auto;
      padding: 12px 18px;
      font-size: 0.85em;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(245,158,66,0.3);
      color: #fff;
      max-width: 98%;
      text-align: center;
    }
    
    .series-framework {
      background: rgba(79,172,254,0.15);
      border: 1px solid #4facfe;
      border-radius: 8px;
      margin: 10px auto;
      padding: 10px 15px;
      font-size: 0.75em;
      color: #4facfe;
      max-width: 98%;
      text-align: left;
    }
    
    /* Failure Mode Styles */
    .failure-mode {
      background: linear-gradient(135deg, rgba(239,68,68,0.9), rgba(245,87,108,0.9));
      border: 2px solid #ef4444;
      border-radius: 6px;
      margin: 10px auto;
      padding: 10px 14px;
      font-size: 0.7em;
      box-shadow: 0 3px 10px rgba(239,68,68,0.4);
      color: #fff;
      max-width: 98%;
      text-align: left;
      animation: pulseRed 2s infinite alternate;
    }
    
    @keyframes pulseRed {
      from { box-shadow: 0 6px 20px rgba(239,68,68,0.4); }
      to { box-shadow: 0 8px 30px rgba(239,68,68,0.7); }
    }
    
    .pressure-point {
      background: rgba(255,255,100,0.2);
      border-left: 3px solid #facc15;
      padding: 6px 12px;
      margin: 6px 0;
      border-radius: 0 4px 4px 0;
      font-size: 0.75em;
    }
    
    .reality-check {
      background: rgba(245,158,66,0.2);
      border-left: 3px solid #f59e42;
      padding: 6px 12px;
      margin: 6px 0;
      border-radius: 0 4px 4px 0;
      font-size: 0.75em;
      font-style: italic;
    }
    
    /* Engineering Solution Styles */
    .engineering-solution {
      background: linear-gradient(135deg, rgba(34,197,94,0.9), rgba(79,172,254,0.9));
      border: 2px solid #22c55e;
      border-radius: 6px;
      margin: 10px auto;
      padding: 10px 14px;
      font-size: 0.7em;
      box-shadow: 0 3px 10px rgba(34,197,94,0.4);
      color: #fff;
      max-width: 98%;
      text-align: left;
    }
    
    /* Drama and Tension Styles */
    .perfect-storm {
      background: radial-gradient(circle, rgba(239,68,68,0.9), rgba(127,29,29,0.9));
      border: 3px solid #dc2626;
      border-radius: 15px;
      margin: 25px auto;
      padding: 25px 30px;
      font-size: 0.9em;
      box-shadow: 0 10px 40px rgba(239,68,68,0.6);
      color: #fff;
      max-width: 90%;
      text-align: center;
      animation: dramaticPulse 1.5s infinite alternate;
    }
    
    @keyframes dramaticPulse {
      from { 
        transform: scale(1);
        box-shadow: 0 10px 40px rgba(239,68,68,0.6);
      }
      to { 
        transform: scale(1.02);
        box-shadow: 0 15px 50px rgba(239,68,68,0.8);
      }
    }
    
    .doomed-text {
      color: #ef4444;
      font-weight: bold;
      font-style: italic;
      animation: fadeInRed 2s ease;
    }
    
    @keyframes fadeInRed {
      from { opacity: 0; color: #666; }
      to { opacity: 1; color: #ef4444; }
    }
    
    /* Stats and Comparisons */
    .comparison-dramatic {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 12px 0;
      font-size: 0.65em;
    }
    
    .comparison-side {
      padding: 10px;
      border-radius: 6px;
      width: 48%;
      text-align: left;
    }
    
    .comparison-side.algorithm {
      background: rgba(79,172,254,0.2);
      border: 2px solid #4facfe;
    }
    
    .comparison-side.engineering {
      background: rgba(34,197,94,0.2);
      border: 2px solid #22c55e;
    }
    
    .comparison-side.broken {
      background: rgba(239,68,68,0.2);
      border: 2px solid #ef4444;
    }
    
    .feynman-diagram {
      background: rgba(236,254,255,0.95);
      border-left: 6px solid #06b6d4;
      border-radius: 10px;
      margin: 16px auto;
      padding: 14px 22px;
      font-size: 0.82em;
      box-shadow: 0 2px 12px 0 rgba(6,182,212,0.15);
      color: #0e3a4a;
      max-width: 85%;
      text-align: left;
    }
    
    .scale-break {
      background: rgba(255,245,230,0.95);
      border-left: 6px solid #f59e42;
      border-radius: 10px;
      margin: 18px auto;
      padding: 16px 22px;
      font-size: 0.85em;
      box-shadow: 0 2px 12px 0 rgba(245,158,66,0.15);
      color: #7c4700;
      max-width: 85%;
      text-align: left;
    }
    
    .comparison {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 10px 0;
      font-size: 0.65em;
    }
    
    .comparison-side.naive {
      background: rgba(255,100,100,0.15);
      border: 2px solid #f5576c;
    }
    
    .comparison-side.production {
      background: rgba(100,255,200,0.15);
      border: 2px solid #3ec6a8;
    }
    
    .comparison-title {
      font-weight: bold;
      margin-bottom: 12px;
      font-size: 1.1em;
    }
    
    .stats-row {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 12px 0;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 8px 15px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.4em;
      font-weight: bold;
      color: #4facfe;
    }
    
    .stat-label {
      font-size: 0.7em;
      opacity: 0.8;
    }
    
    .reveal pre {
      font-size: 0.75em;
      width: 98%;
      margin: 0 auto;
      line-height: 1.4;
    }
    
    .reveal pre code {
      max-height: 380px;
      overflow-y: auto;
      padding: 12px 15px;
      border-radius: 8px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }
    
    .act-intro {
      font-size: 0.75em;
      opacity: 0.9;
      max-width: 95%;
      margin: 0 auto;
      line-height: 1.5;
    }
    
    .act-title {
      text-align: center;
    }
    
    .act-title h1 {
      font-size: 2.5em !important;
      margin-bottom: 10px;
    }
    
    blockquote {
      font-style: italic;
      border-left: 4px solid #4facfe;
      padding-left: 20px;
      margin: 20px auto;
      max-width: 80%;
    }
    
    .dramatic-quote {
      font-style: italic;
      font-size: 1.1em;
      color: #f59e42;
      margin: 20px auto;
      padding: 15px;
      border: 1px solid rgba(245,158,66,0.3);
      border-radius: 8px;
      background: rgba(245,158,66,0.1);
    }
    
    /* Company badges */
    .company-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.7em;
      margin: 3px;
      font-weight: bold;
    }
    
    .company-badge.rocksdb {
      background: rgba(255,107,0,0.2);
      border: 1px solid #ff6b00;
      color: #ff6b00;
    }
    
    .company-badge.cassandra {
      background: rgba(26,188,156,0.2);
      border: 1px solid #1abc9c;
      color: #1abc9c;
    }
    
    .company-badge.bigtable {
      background: rgba(66,133,244,0.2);
      border: 1px solid #4285f4;
      color: #4285f4;
    }
    
    /* Leetcode badge */
    .leetcode-badge {
      background: linear-gradient(135deg, #ffa116, #ff6b00);
      padding: 6px 15px;
      border-radius: 6px;
      font-weight: bold;
      display: inline-block;
      margin: 8px 0;
      color: #fff;
    }
    
    /* Architecture diagram */
    .architecture-flow {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .arch-box {
      background: rgba(79,172,254,0.2);
      border: 2px solid #4facfe;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: bold;
      font-size: 0.85em;
    }
    
    .arch-arrow {
      color: #22c55e;
      font-size: 1.5em;
    }
    
    /* Metric cards */
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 15px auto;
      max-width: 600px;
    }
    
    .metric-card {
      background: linear-gradient(135deg, rgba(79,172,254,0.1), rgba(136,87,255,0.1));
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    
    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #4facfe;
    }
    
    .metric-label {
      font-size: 0.7em;
      color: #8b949e;
      margin-top: 5px;
    }
    
    /* Guarantee table */
    .guarantee-table {
      width: 90%;
      margin: 15px auto;
      border-collapse: collapse;
      font-size: 0.75em;
    }
    
    .guarantee-table th,
    .guarantee-table td {
      border: 1px solid #30363d;
      padding: 10px;
      text-align: left;
    }
    
    .guarantee-table th {
      background: rgba(79,172,254,0.2);
    }
  </style>
</head>
<body>
  <div class="reveal">
    <div class="slides">

      <!-- ============ TITLE SLIDE ============ -->
      <section data-background="linear-gradient(135deg, #0d1117 0%, #161b22 50%, #21262d 100%)">
        <h1>ğŸ” Episode 2.1</h1>
        <h2 style="color: #4facfe;">Sorted Logs</h2>
        <h3 style="color: #8b949e;">When Binary Search Meets Persistence</h3>
        
        <div style="margin-top: 30px;">
          <span class="leetcode-badge">LeetCode #704: Binary Search</span>
        </div>
        
        <div style="margin-top: 20px;">
          <span class="company-badge rocksdb">RocksDB</span>
          <span class="company-badge cassandra">Cassandra</span>
          <span class="company-badge bigtable">Bigtable</span>
        </div>
        
        <p style="margin-top: 30px; font-size: 0.7em; color: #8b949e;">
          Season 2: Binary Search â€” Building a Database Index
        </p>
      </section>

      <!-- ============ THE HOOK ============ -->
      <section>
        <h2>ğŸš¨ The 3 AM Page</h2>
        
        <div class="perfect-storm">
          <p style="font-size: 1.2em;">Database query that normally takes <strong style="color: #22c55e;">10ms</strong></p>
          <p style="font-size: 1.4em; margin-top: 10px;">Suddenly takes <strong style="color: #ef4444;">10 seconds</strong></p>
        </div>
        
        <div style="margin-top: 20px; font-size: 0.85em;">
          <p>âœ“ Indexes exist</p>
          <p>âœ“ Query plan looks right</p>
          <p>âœ“ No obvious errors</p>
        </div>
        
        <div class="dramatic-quote" style="margin-top: 25px;">
          "The answer lies in an algorithm you learned in CS 101..."
        </div>
      </section>

      <!-- ============ THE JOURNEY ============ -->
      <section>
        <h2>Today's Journey</h2>
        
        <div class="architecture-flow">
          <div class="arch-box" style="background: rgba(255,161,22,0.2); border-color: #ffa116;">
            LeetCode #704<br><span style="font-size: 0.7em; opacity: 0.8;">Binary Search</span>
          </div>
          <div class="arch-arrow">â†’</div>
          <div class="arch-box">
            Write-Ahead Log<br><span style="font-size: 0.7em; opacity: 0.8;">Toy System</span>
          </div>
          <div class="arch-arrow">â†’</div>
          <div class="arch-box" style="background: rgba(34,197,94,0.2); border-color: #22c55e;">
            SSTables<br><span style="font-size: 0.7em; opacity: 0.8;">Production</span>
          </div>
        </div>
        
        <div class="thesis-box" style="margin-top: 30px;">
          We'll <strong>build it</strong>, <strong style="color: #ef4444;">break it</strong>, and <strong style="color: #22c55e;">harden it</strong> into production
        </div>
      </section>

      <!-- ============ ACT I: THE ALGORITHM ============ -->
      <section>
        <section>
          <div class="act-title">
            <h1>ğŸ­ ACT I</h1>
            <h2>The Perfect Algorithm</h2>
          </div>
          <p class="act-intro">Where we meet binary search and discover its hidden requirement</p>
        </section>
        
        <section>
          <h2><span class="leetcode-badge">LeetCode #704</span></h2>
          <h3>Binary Search</h3>
          
          <div class="feynman-diagram">
            <strong>Problem:</strong> Given a <em>sorted</em> array of integers, find target in O(log n) time
          </div>
          
          <pre><code class="language-python">def binary_search(arr, target):
    left, right = 0, len(arr) - 1
    
    while left <= right:
        mid = left + (right - left) // 2  # Avoid overflow
        
        if arr[mid] == target:
            return mid
        elif arr[mid] < target:
            left = mid + 1
        else:
            right = mid - 1
    
    return -1</code></pre>
          
          <p style="margin-top: 15px; color: #22c55e; font-size: 0.75em;">
            âœ“ Clean code â€¢ âœ“ O(log n) time â€¢ âœ“ Simple logic
          </p>
        </section>
        
        <section>
          <h2>The Fundamental Requirement</h2>
          
          <div style="font-size: 3em; margin: 30px 0; color: #4facfe;">
            ğŸ“Š SORTED DATA
          </div>
          
          <div class="feynman-diagram">
            <strong>The Insight:</strong> Binary search only works on <em>sorted</em> data.<br><br>
            This "obvious" constraint becomes <strong>everything</strong> when we move to production systems.
          </div>
          
          <p style="margin-top: 20px; font-size: 0.85em;">
            The real concept isn't O(log n) searchâ€”<br>
            it's <strong style="color: #f59e42;">maintaining sorted order</strong> for efficient lookup.
          </p>
          
          <div class="dramatic-quote">
            "This is the DNA of database indexes."
          </div>
        </section>
      </section>

      <!-- ============ ACT II: TOY SYSTEM ============ -->
      <section>
        <section>
          <div class="act-title">
            <h1>ğŸ­ ACT II</h1>
            <h2>The Toy System</h2>
          </div>
          <p class="act-intro">Where we build a Write-Ahead Log and watch it break</p>
        </section>
        
        <section>
          <h2>ğŸ—„ï¸ Write-Ahead Logging</h2>
          
          <div class="scale-break">
            <strong>The Problem:</strong> Every database needs <em>durability</em>.<br>
            If power fails, committed writes shouldn't disappear.
          </div>
          
          <div class="architecture-flow" style="margin-top: 25px;">
            <div class="arch-box">Write Request</div>
            <div class="arch-arrow">â†’</div>
            <div class="arch-box" style="background: rgba(255,107,0,0.2); border-color: #ff6b00;">WAL (Disk)</div>
            <div class="arch-arrow">â†’</div>
            <div class="arch-box">Main Database</div>
          </div>
          
          <p style="margin-top: 20px; font-size: 0.8em; color: #8b949e;">
            Before data goes to main DB, it gets written to a log on disk
          </p>
        </section>
        
        <section>
          <h2>ToyWAL Design</h2>
          
          <div class="comparison-dramatic">
            <div class="comparison-side algorithm">
              <h3 style="color: #4facfe;">ğŸ“ Structure</h3>
              <ul>
                <li>Append-only log file</li>
                <li>Entry: <code>timestamp|key|value</code></li>
                <li>In-memory index â†’ file positions</li>
              </ul>
            </div>
            <div class="comparison-side engineering">
              <h3 style="color: #22c55e;">âœ“ Guarantees</h3>
              <ul>
                <li>O(1) lookups</li>
                <li>Durability (fsync)</li>
                <li>Simple implementation</li>
              </ul>
            </div>
          </div>
        </section>
        
        <section>
          <h3>ToyWAL Implementation</h3>
          
          <pre><code class="language-python">class ToyWAL:
    def __init__(self, log_file="wal.log"):
        self.log_file = log_file
        self.index = {}  # key -> file_position
        
    def append(self, key, value):
        entry = f"{time.time()}|{key}|{value}\n"
        with open(self.log_file, 'a') as f:
            pos = f.tell()
            f.write(entry)
            f.flush()  # Force write to disk
        self.index[key] = pos
        
    def get(self, key):
        if key not in self.index:
            return None
        pos = self.index[key]
        with open(self.log_file, 'r') as f:
            f.seek(pos)
            line = f.readline()
            _, _, value = line.strip().split('|')
        return value</code></pre>
        </section>
        
        <section>
          <h2>âš ï¸ The Critical Assumption</h2>
          
          <div class="failure-mode">
            <h3 style="margin-top: 0;">ğŸ’€ The index lives in MEMORY</h3>
            <p>What happens when we restart the process?</p>
          </div>
          
          <pre><code class="language-python">def rebuild_index(self):
    """Must read ENTIRE log on startup"""
    self.index = {}
    with open(self.log_file, 'r') as f:
        pos = 0
        for line in f:  # O(n) - reads EVERYTHING!
            timestamp, key, value = line.strip().split('|')
            self.index[key] = pos
            pos += len(line)</code></pre>
          
          <div class="perfect-storm" style="margin-top: 15px; padding: 15px;">
            With 1TB of data â†’ <strong>3+ hours downtime</strong> per restart
          </div>
        </section>
      </section>

      <!-- ============ ACT III: FAILURE MODES ============ -->
      <section>
        <section>
          <div class="act-title">
            <h1>ğŸ­ ACT III</h1>
            <h2>The Breaking Point</h2>
          </div>
          <p class="act-intro">Where production scale destroys our beautiful toy</p>
        </section>
        
        <section>
          <h2><span style="background: #ef4444; padding: 5px 15px; border-radius: 5px;">Failure Mode #1</span></h2>
          <h3>The Rebuild Time Problem</h3>
          
          <pre><code class="language-python"># Process crashes, memory is wiped
# To restart: must call rebuild_index()

# With 1TB log at 100MB/s sequential read:
# 1TB / 100MB/s = 10,000 seconds = ~3 hours downtime

# Every restart = 3 hours offline
# In production: UNACCEPTABLE</code></pre>
          
          <div class="engineering-solution" style="margin-top: 20px;">
            <strong>ğŸ’¡ Solution:</strong> Make the log itself searchable without full scan<br>
            <span style="color: #22c55e;">â†’ Sorted on-disk structure</span>
          </div>
        </section>
        
        <section>
          <h2><span style="background: #ef4444; padding: 5px 15px; border-radius: 5px;">Failure Mode #2</span></h2>
          <h3>Concurrent Writes Corrupt Data</h3>
          
          <pre><code class="language-python"># Two threads writing simultaneously
threads = [
    Thread(target=lambda: wal.append(f"key:{i}", f"value:{i}"))
    for i in range(1000)
]
[t.start() for t in threads]

# Result in log file:
# "1234|key:1|val1234|key:2|val"  â† MANGLED!
# File append() is NOT atomic across threads</code></pre>
          
          <div class="engineering-solution" style="margin-top: 20px;">
            <strong>ğŸ’¡ Solution:</strong> Batch writes in memory, flush atomically
          </div>
        </section>
        
        <section>
          <h2><span style="background: #ef4444; padding: 5px 15px; border-radius: 5px;">Failure Mode #3</span></h2>
          <h3>Unbounded Growth Problem</h3>
          
          <pre><code class="language-python"># Updates create duplicate entries
wal.append("user:100", "Alice")
wal.append("user:100", "Alice-Updated")  # Old entry still on disk!
wal.append("user:101", "DELETE")         # Tombstone marker

# After 1 year of operation:
# - 10TB of log data on disk
# - Only 1TB is current data
# - 90% of disk space wasted!</code></pre>
          
          <div class="engineering-solution" style="margin-top: 20px;">
            <strong>ğŸ’¡ Solution:</strong> Compaction â€” merge old entries, remove tombstones
          </div>
        </section>
      </section>

      <!-- ============ ACT IV: PRODUCTION HARDENING ============ -->
      <section>
        <section>
          <div class="act-title">
            <h1>ğŸ­ ACT IV</h1>
            <h2>The Resurrection</h2>
          </div>
          <p class="act-intro">Where SSTables save the day</p>
        </section>
        
        <section>
          <h2>ğŸ—ï¸ Enter: SSTables</h2>
          <h3 style="color: #8b949e;">Sorted String Tables</h3>
          
          <div style="margin: 25px 0;">
            <span class="company-badge rocksdb">RocksDB</span>
            <span class="company-badge cassandra">Cassandra</span>
            <span class="company-badge bigtable">Bigtable</span>
          </div>
          
          <div class="thesis-box">
            The foundation of modern databases for 20+ years
          </div>
          
          <div class="feynman-diagram" style="margin-top: 20px;">
            <strong>Key Insight:</strong> Don't binary search millions of entries.<br>
            Instead: Binary search <em>hundreds of blocks</em>, then scan one 4KB block.
          </div>
        </section>
        
        <section>
          <h2>Two-Level Search</h2>
          
          <pre style="font-size: 0.6em; text-align: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SPARSE INDEX                             â”‚
â”‚  "aaa" â†’ 0    "dog" â†’ 4096    "fox" â†’ 8192    "zoo" â†’ 12288 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Block 0     â”‚  Block 1     â”‚  Block 2     â”‚  Block 3     â”‚
â”‚  4KB         â”‚  4KB         â”‚  4KB         â”‚  4KB         â”‚
â”‚  aaa...dog   â”‚  dog...fox   â”‚  fox...zoo   â”‚  zoo...zzz   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Binary search sparse index â†’ find block
Step 2: Sequential scan 4KB block â†’ find key</code></pre>
          
          <div class="metric-grid" style="margin-top: 20px;">
            <div class="metric-card">
              <div class="metric-value">250M</div>
              <div class="metric-label">Entries (1TB)</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">~28</div>
              <div class="metric-label">Disk Seeks</div>
            </div>
          </div>
        </section>
        
        <section>
          <h3>SSTable Segment Implementation</h3>
          
          <pre><code class="language-python">class SSTableSegment:
    def __init__(self, filename):
        self.filename = filename
        self.sparse_index = {}  # first_key â†’ file_offset
        self.block_size = 4096  # 4KB blocks
        
    def get(self, target_key):
        # Step 1: Binary search sparse index
        block_keys = sorted(self.sparse_index.keys())
        block_idx = bisect.bisect_right(block_keys, target_key) - 1
        if block_idx < 0:
            return None
            
        block_offset = self.sparse_index[block_keys[block_idx]]
        
        # Step 2: Sequential scan one 4KB block
        with open(self.filename, 'rb') as f:
            f.seek(block_offset)
            block_data = f.read(self.block_size)
            for line in block_data.decode().split('\n'):
                key, value = line.split(':', 1)
                if key == target_key:
                    return value
        return None</code></pre>
        </section>
        
        <section>
          <h2>Production Architecture</h2>
          
          <div class="architecture-flow">
            <div class="arch-box" style="background: rgba(255,161,22,0.2); border-color: #ffa116;">
              Write
            </div>
            <div class="arch-arrow">â†’</div>
            <div class="arch-box" style="background: rgba(136,87,255,0.2); border-color: #8957ff;">
              Memtable<br><span style="font-size: 0.7em;">(In-Memory)</span>
            </div>
            <div class="arch-arrow">â†’</div>
            <div class="arch-box" style="background: rgba(34,197,94,0.2); border-color: #22c55e;">
              SSTable<br><span style="font-size: 0.7em;">(On-Disk)</span>
            </div>
          </div>
          
          <div class="comparison-dramatic" style="margin-top: 25px;">
            <div class="comparison-side algorithm">
              <h4 style="color: #8957ff;">Memtable</h4>
              <ul>
                <li>Fast writes (memory)</li>
                <li>Sorted structure</li>
                <li>Size limited (64MB)</li>
              </ul>
            </div>
            <div class="comparison-side engineering">
              <h4 style="color: #22c55e;">SSTable</h4>
              <ul>
                <li>Durable (disk)</li>
                <li>Immutable</li>
                <li>Compacted periodically</li>
              </ul>
            </div>
          </div>
        </section>
        
        <section>
          <h2>ğŸ“– Read Path</h2>
          
          <pre><code class="language-python">def get(self, key):
    # 1. Check memtable first (hottest, most recent)
    if key in self.memtable:
        return self.memtable[key]
    
    # 2. Check SSTables newest to oldest
    for segment in reversed(self.segments):
        value = segment.get(key)
        if value is not None:
            return value
    
    return None  # Key not found</code></pre>
          
          <div class="feynman-diagram" style="margin-top: 20px;">
            <strong>Temporal locality:</strong> Check hot data first<br>
            <strong>Latest value wins:</strong> Newest segment has current data
          </div>
        </section>
        
        <section>
          <h2>âœï¸ Write Path</h2>
          
          <pre><code class="language-python">def put(self, key, value):
    # Backpressure: block if memtable full
    if self.memtable_size > self.max_memtable_size:
        self._flush_memtable_to_disk()
    
    # Write to in-memory buffer
    self.memtable[key] = value
    self.memtable_size += len(key) + len(value)
    
    # Also write to WAL for crash recovery
    self.wal.append(key, value)</code></pre>
          
          <div class="engineering-solution" style="margin-top: 15px;">
            <strong>O(1) amortized writes</strong> â€” memory is fast!
          </div>
        </section>
        
        <section>
          <h2>ğŸ”„ Compaction</h2>
          <p style="font-size: 0.8em; color: #8b949e;">Merge segments, remove tombstones, reclaim space</p>
          
          <pre><code class="language-python">def _compact_segments(self):
    # Merge multiple segments into one
    merged_entries = []
    for segment in self.segments[-3:]:
        merged_entries.extend(segment.read_all_entries())
    
    # Remove tombstones, keep latest version
    latest = {}
    for key, value in sorted(merged_entries):
        if value != "DELETE":
            latest[key] = value
    
    # Write new compacted segment
    new_segment = SSTableSegment(f"compact_{time.time()}.sst")
    new_segment.write_segment(sorted(latest.items()))</code></pre>
        </section>
        
        <section>
          <h2>ğŸ“Š Production Monitoring</h2>
          
          <pre><code class="language-python">self.metrics = {
    'write_ops_total': 0,
    'read_ops_total': 0,
    'memtable_flushes': 0,
    'disk_bytes_read': 0,
    'p99_read_latency_ms': 0,
    'segment_count': 0,
    'compaction_running': False
}</code></pre>
          
          <div class="metric-grid" style="margin-top: 20px;">
            <div class="metric-card">
              <div class="metric-value">&lt;10ms</div>
              <div class="metric-label">P99 Read Latency</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">&lt;50ms</div>
              <div class="metric-label">P99 Write Latency</div>
            </div>
          </div>
        </section>
        
        <section>
          <h2>ğŸ“œ Production Guarantees</h2>
          
          <table class="guarantee-table">
            <tr>
              <th>Guarantee</th>
              <th>Description</th>
            </tr>
            <tr>
              <td><strong style="color: #22c55e;">Durability</strong></td>
              <td>All acknowledged writes survive crashes</td>
            </tr>
            <tr>
              <td><strong style="color: #4facfe;">Consistency</strong></td>
              <td>Readers see all previously committed writes</td>
            </tr>
            <tr>
              <td><strong style="color: #f59e42;">Performance</strong></td>
              <td>O(log n) reads, O(1) amortized writes</td>
            </tr>
            <tr>
              <td><strong style="color: #8957ff;">Recovery</strong></td>
              <td>&lt;30 seconds for 1TB data</td>
            </tr>
          </table>
        </section>
        
        <section>
          <h2>âœ… Failure Modes Handled</h2>
          
          <div class="comparison-dramatic">
            <div class="comparison-side engineering">
              <h4 style="color: #22c55e;">Process Crash</h4>
              <p>Recover from WAL</p>
              <h4 style="color: #22c55e; margin-top: 15px;">Disk Corruption</h4>
              <p>Detect via checksums</p>
            </div>
            <div class="comparison-side engineering">
              <h4 style="color: #22c55e;">Memory Pressure</h4>
              <p>Spill to disk automatically</p>
              <h4 style="color: #22c55e; margin-top: 15px;">Hot Keys</h4>
              <p>Concurrent readers</p>
            </div>
          </div>
        </section>
      </section>

      <!-- ============ ACT V: NEXT PROBLEM ============ -->
      <section>
        <section>
          <div class="act-title">
            <h1>ğŸ­ ACT V</h1>
            <h2>The Next Challenge</h2>
          </div>
          <p class="act-intro">Where success creates new problems</p>
        </section>
        
        <section>
          <h2>ğŸ¯ System Deployed!</h2>
          
          <div class="metric-grid">
            <div class="metric-card">
              <div class="metric-value">1M+</div>
              <div class="metric-label">Writes/Second</div>
            </div>
            <div class="metric-card">
              <div class="metric-value">5ms</div>
              <div class="metric-label">P99 Latency</div>
            </div>
          </div>
          
          <div class="scale-break" style="margin-top: 25px;">
            <strong>Then Product comes with a new requirement...</strong>
          </div>
        </section>
        
        <section>
          <h2>ğŸ“‹ The New Requirement</h2>
          
          <div class="thesis-box" style="font-size: 1em;">
            "Show me all posts by <strong style="color: #4facfe;">user:12345</strong><br>
            from the <strong style="color: #22c55e;">last 7 days</strong>"
          </div>
          
          <pre><code class="language-python"># Our current API:
def get(key):  # Returns ONE value for ONE key
    ...

# No way to say:
# "Give me all keys matching a pattern"
# "Give me all keys in a time range"</code></pre>
        </section>
        
        <section>
          <h2>Three Options</h2>
          
          <div class="failure-mode" style="animation: none;">
            <h4 style="margin: 0;">Option 1: Giant Blob</h4>
            <p>Store all posts in one value â†’ Rewrite 1MB for each new post ğŸ˜±</p>
          </div>
          
          <div class="failure-mode" style="animation: none;">
            <h4 style="margin: 0;">Option 2: Million get() calls</h4>
            <p>1000 posts Ã— 10ms = 10 seconds latency ğŸ˜±</p>
          </div>
          
          <div class="engineering-solution">
            <h4 style="margin: 0;">Option 3: Range Queries âœ…</h4>
            <p>One seek to start, sequential scan â†’ Fast!</p>
          </div>
        </section>
        
        <section>
          <h2>ğŸ”® Next Episode Preview</h2>
          
          <h3 style="color: #4facfe;">Range Queries & Infinite Scroll</h3>
          
          <div style="margin: 20px 0;">
            <span class="leetcode-badge">LeetCode #34: Find First and Last Position</span>
          </div>
          
          <div class="feynman-diagram">
            <strong>lower_bound</strong> and <strong>upper_bound</strong><br>
            The fundamental operations for efficient range scans
          </div>
          
          <div class="dramatic-quote" style="margin-top: 20px;">
            We'll build <strong>infinite scroll pagination</strong> for social media feeds.<br>
            <span style="font-size: 0.8em; color: #8b949e;">At Twitter scale. Without duplicates or skips.</span>
          </div>
        </section>
      </section>

      <!-- ============ KEY TAKEAWAYS ============ -->
      <section>
        <h2>ğŸ“š Key Takeaways</h2>
        
        <ol style="font-size: 0.8em; text-align: left; max-width: 90%; margin: 0 auto;">
          <li style="margin: 12px 0;">
            <strong style="color: #4facfe;">Binary Search â†’ Sorted Storage</strong><br>
            <span style="opacity: 0.8;">Algorithm's requirement becomes system's requirement</span>
          </li>
          <li style="margin: 12px 0;">
            <strong style="color: #22c55e;">Toy to Production Journey</strong><br>
            <span style="opacity: 0.8;">Simple log â†’ 3 failures â†’ hardened SSTable</span>
          </li>
          <li style="margin: 12px 0;">
            <strong style="color: #f59e42;">Production Patterns</strong><br>
            <span style="opacity: 0.8;">SSTables, Compaction, RW Locks, Checksums</span>
          </li>
          <li style="margin: 12px 0;">
            <strong style="color: #8957ff;">When to Use</strong><br>
            <span style="opacity: 0.8;">Write-heavy, read-recent workloads</span>
          </li>
        </ol>
      </section>

      <!-- ============ THE BIG INSIGHT ============ -->
      <section>
        <h2>ğŸ’¡ The Big Insight</h2>
        
        <div class="feynman-diagram" style="font-size: 0.95em;">
          Every database index is fundamentally a <strong style="color: #4facfe;">sorted data structure</strong> 
          that enables <strong style="color: #22c55e;">binary search</strong>.
          <br><br>
          The innovation isn't the search algorithmâ€”it's <strong style="color: #f59e42;">maintaining that sorted order</strong> 
          efficiently on persistent storage while handling every possible failure mode.
        </div>
      </section>

      <!-- ============ END SLIDE ============ -->
      <section data-background="linear-gradient(135deg, #0d1117 0%, #161b22 50%, #21262d 100%)">
        <h1>See You in Episode 2.2!</h1>
        <h2 style="color: #4facfe;">"Bound Search â€” The Infinite Scroll Algorithm"</h2>
        
        <div style="margin-top: 40px;">
          <span class="company-badge rocksdb">RocksDB</span>
          <span class="company-badge cassandra">Cassandra</span>
          <span class="company-badge bigtable">Bigtable</span>
        </div>
        
        <p style="margin-top: 30px; font-size: 0.7em; color: #8b949e;">
          Season 2: Binary Search â€” Building a Database Index
        </p>
      </section>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/reveal.js/plugin/highlight/highlight.js"></script>
  <script>
    Reveal.initialize({
      hash: true,
      slideNumber: 'c/t',
      showSlideNumber: 'all',
      transition: 'slide',
      transitionSpeed: 'default',
      backgroundTransition: 'fade',
      plugins: [ RevealHighlight ]
    });
  </script>
</body>
</html>
